# Calendar Mirror #

Calendar Mirror is a Rust application that displays events from a
user's Google calendar on a PaPiRus ePaper display on a Raspberry Pi.

## Installation and Setup ##

### Hardware ###

This project has been developed for a Raspberry Pi 3 B+ with a 2.7"
PaPiRus ePaper HAT module installed. Other Raspberry Pi versions
(apart from the Raspberry Pi Zero) might also suffice. Smaller
versions of the PaPiRus HAT might also be compatible if some changes
to the rendering code are made <sup>[1](#screens)</sup> &mdash;
however the lack of screen space might prove limiting.

Assemble the hardware as described
[here](https://learn.pi-supply.com/make/papirus-assembly-tips-and-gotchas/). That
website refers to a pogo pin, but it is not required for this project.

### Operating System and Drivers ###

The OS was Raspbian Buster. No other OS versions have been
tested. However it's likely that the code will run on other operating
systems with few if any changes.

The following are the list of software dependencies required to
compile and run this project:

1. Operating System: Raspbian, (the version tested is based on Debian
   Stretch). The list of packages installed on the Raspberry Pi can be
   found at
   <http://hourglassapps.com/calendar_mirror/packages.txt>. This list
   was generated by entering the dpkg --get-selections
   command. Conversely the same packages can be installed by
   downloading the list above and from within the download directory,
   entering:

	`sudo /usr/lib/dpkg/methods/apt/update /var/lib/dpkg/`
	`sudo dpkg --set-selections < packages.txt`
	`sudo apt-get dselect-upgrade`

	Note you will see warnings appear about certain packages not found
    in the status or available databases.

2. [PaPiRus drivers](https://github.com/PiSupply/PaPiRus). Install
   these as described in the link. If prompted for the python version,
   you will need to install the python3 version of the API. If you
   wish to test most of the example programs that come with the
   PaPiRus download you will also need to install the python2 version
   of the API. When installing according the Auto Installation method,
   you might encounter the following warning:
   
   `A dependency job for epd-fuse.service failed. See 'journalctl -xe' for details.`
   
   This warning can be ignored.
   
3. The application assumes there is a working network connection so
   please ensure that the Raspberry Pi is preconfigured to have a
   working network connection in the environment where it will
   eventually be used.

If you wish to test Calendar Mirror, without fully installing you can
jump ahead to the Install Toolchain and Download Source
section. Otherwise continue with the next two sections which will
describe how to setup your Raspberry Pi so that filesystem partitions,
are for the most part, mounted in read-only mode, allowing you to
power-off the unit by simply unplugging the power cable (unless the
display warns the user not to disconnect power).

### Configuration Partition ###

Calendar Mirror is designed to run on a system where all partitions
have been mounted read-only by default. Application configuration is
saved on a dedicated ext4 partition. Normally this partition is also
mounted read-only, but when a change needs to be saved it is
temporarily remounted in read-write mode. The application displays a
warning on the ePaper display for the entire duration that this
partition is mounted in read-write mode.

You will now need to create this configuration partition:

Create a new small Linux partition (7 or 8 Mib in size will be ample)
on your SD-Card. If there isn't sufficient free space in your patition
table you might need to shrink one of your existing partitions first
to create some free space using an application such as GParted. You
will need to ensure that the partition is not mounted before shrinking
it. Shrinking the root partition, if required, must be done from a
different device as it cannot be unmounted while the Raspberry Pi is
running.

On the new partition, create an ext4 filesystem with the mkfs command,
if it has not already be created by your partitioning software and
once that is done, create a mount-point for the new partition:

`sudo mkdir -p /var/opt/calendar_mirror`

### Filesystem Configuration ###

To protect against filesystem corruption that could be caused by power
interruptions it is prudent to ensure that any mounted partitions are
read-only. A tmpfs overlay allows programs that require read-write
access to the filesystem for logging etc. to operate as normal.

More information on how to accomplish both tasks can be found on the
[raspberrypi
forums](https://www.raspberrypi.org/forums/viewtopic.php?p=1044893).

Switching between mounting the root partition as read-only and
mounting as read-write is as easy as editing /boot/cmdline.txt
deleting or inserting boot=overlay. The Raspberry Pi will need to be
rebooted for the change to take effect. For now please ensure that the
root partition is mounted in read-write mode.

Update your /etc/fstab to mount /boot as readonly by default
and the configuration partition you created above as read-write. An
example fstab file (where /dev/mmcblk0p8 is the device corresponding
to the configuration partition) can be found at
<http://hourglassapps.com/calendar_mirror/fstab>. If you intend to
copy this file you will need to ensure that the device names
(including that of the configuration partition) are correct.

The reason the configuration partition can mounted read-only at
boot-up is because we know that the only application that will attempt
to write to it is Calendar Mirror. Once that application starts after
a power up or reboot it will remount that partition in read-only mode,
only remounting temporarily as read-write when necessary to update its
configuration. While this is occurring a warning is be displayed on
the device indicating that it should not be powered down.

From now on if you need to edit a file in /boot such as
/boot/cmdline.txt you will first need to temporarily remount /boot in
read-write mode with the command:

`sudo mount /boot -o remount,rw`

For Calendar Mirror to function correctly, before installing you will
need to edit the systemd/calendar_mirror.service file in your git
working directory to ensure the line beginning with "Environment=" is
correct. More specifically you might need to change the value of the
CALENDAR\_MIRROR\_DEV environment variable value to match the device
path of your configuration partition.

### Install Toolchain and Download Source ###

Calendar Mirror can be compiled with the stable rust
toolchain. Install the rust toolchain on your Raspberry Pi as
described on the [Rust](https://www.rust-lang.org/) website.

Clone the Calendar Mirror repository with the command:

`git clone https://github.com/kieranjwhite/calendar_mirror.git`

### Set Client Id. and Secret ###

Calendar Mirror authenticates using an OAuth2 client ID and
secret. You will need to generate these items and then include them in
the Calendar Mirror source.

Step 1 of Google's [authentication
document](https://developers.google.com/identity/protocols/OAuth2)
describes in general terms how to a create the ID and secret. However
specifically the steps are as follows:

1. Visit the [developer console URL](https://console.developers.google.com/).
2. Click on the combo box to the right of the GoogleAPIs logo in the
   top-left of the screen. A dialog box appears.
3. Select the New Project in the top right of the dialog box. A new
   screen will appear. Change the content of the Project name text
   field to Calendar Mirror and click Create.
4. You will be returned to the developer console. Select the + Enable
   APIs and Service button. The API selection screen appears.
5. In the Search for APIs and Services search box search for the
   keyword calendar. Of the results returned select the Google
   Calendar API result.
6. In the API screen that appears, click the Enable button. You willl
   be returned to the developer console once again. Select the
   Credentials item in the naviagtion bar.
7. Next click on the Credentials in APIs & Services link then click the
   Create Credentials button in the dialog box that appears.
8. A list of options appears. Select the OAuth client ID
   option. Another screen, Create OAuth client ID, appears.
9. Click on the Configure consent screen button. In the OAuth consent
   screen tab that you will presented with first change the
   Application name to Calendar Mirror. Next click on the Add scope
   button. You will be presented with a list of scopes. Click on
   ../auth/calendar.events.readonly and then the Add button.
10. You will be returned to the OAuth consent screen tab. Scroll to
   the bottom and click Save.
11. Now you will be returned to the Create OAuth client ID
    screen. Select Other and change the Name field to calendar_mirror.
12. Click on the Create button. A dialog will appear providing you
    with your client ID and secret. These values can be retrieved from
    the developer console at any time by clicking on the Credentials
    navigation item and then the 'pencil' icon on the calendar_mirror
    row.
13. Next edit the file src/cal_machine/retriever.rs, change the
	specified values for CLIENT\_ID\_VAL and CLIENT\_SECRET\_VAL to
	match the new client id. and secret and then save.

### Build ###

Change to the directory containing the cloned project and enter:

`cargo build`

Assuming the the application compiles without errors you can either
proceed to the next section to install Calendar Mirror or you can test
it without installing, which is described next.

### Testing ###

Remaining in the project directory enter the following:

`sudo PATH=$PATH:./scripts ./target/debug/calendar_mirror`

The application runs as root because, when starting up it synchronises
the system time with a network server.

### Installation ###

You can install the binary and related resources with the command:

`sudo ./target/debug/calendar_mirror --install`

This command will replace any previous calendar\_mirror installs with
the new one. If there aren't any older installs of the application you
will see a couple of systemd errors that are generated when the
installer attempts to to stop the old non-existent calendar_mirror
service. These can be ignored.

Finally remount /boot in read-write mode as described above and edit
/boot/cmdline.txt to ensure the Raspberry Pi root directory will in
future be mounted read-only. Finally reboot and verify that Calendar
Mirror restarts after rebooting.

## Operating Instructions ##

### Getting Started ###

When the application runs for the first time it will request a device
code from the user. Visit the URL on the ePaper display in a browser
on one of your device. The user will be asked to chose one of his the
gmail addresses. The selected account identifies which person's
calendar will be accessed by the application.

Next enter the code shown on the unit (without any dashes). When
prompted to grant permission to view calendars select the Allow button
in the browser. On the ePaper display there will be an indication that
configuration is being saved. Once saved, today's events will be
listed. The user will not normally need to be authenticated again
unless there is a long-press of the reset button. The event screen
will now be displayed. While the event screen is visible the user will
be able to interact with the application using the four control
buttons.

### Event Screen ###

#### Introduction ####

The image below shows the layout of the event screen. There are a
number of components visible in this screen:

1. Status Indicator,
2. Display Date,
3. E-mail address of Calendar Owner,
4. The list of Events and possible the Current Time.

![annotated photo of Raspberry Pi with ePaper display running Calendar
Mirror](https://github.com/kieranjwhite/calendar_mirror/raw/master/docs/annotated_display.jpg)

These will be discussed next.

#### Display Date ####

At the top of the screen is the display date. That date can be changed
with the control buttons. Changing the date does not immediately
result in the new day's events being downloaded. The new events are
only downloaded 1500ms after the release of the Previous Date or Next
Date control button. This allows the user to navigate relatively
quickly to the date of interest before incurring a delay associated
with the remote download.

#### E-mail ####

In the calendar data that is retrieved from Google an E-mail address
is associated with each event and this occupies the top-right of the
screen. Where there are no events or there is more than one E-mail
address linked with the day's events then the label "E-mail not
listed" is shown instead.

#### Status Indicator ####

In the top left of the a character will be displayed. This
character acts as a heatbeat indicator and also conveys general
status information.

* **Flashing '!'.** The unit is powered up and the application is
  running normally and connected to the Internet.
* **Steady 'G'.** A network operation is in progress. While this is
  showing the unit will not respond to button presses. If 'G' remains
  on screen for a number of seconds it is likely that the Internet has
  just been disconnected. If so, eventually the operation will
  eventually timeout and the status indicator will switch to a
  flashing 'i'.
* **Flashing 'i'.** The unit is powered up and the application is
  running but is disconnected from the Internet. In this state the
  user will be unable to navigate to a different date because
  doing so would require that the new day's events to be downloaded.
* **Anything else (i.e. steady '!', 'i' or a blank).** The application
  is not running. The most likely explanation is that the power is
  disconnected.

#### Events and Current Time ####

Once the unit is powered up and the user has been successfully
authenticated, the events for today will be listed in the
chronological order. Anytime today is the display date and an event
is currently in progress a '<' symbol will be shown alongside
it. If today is selected but no events are currently in progress a
separate line indicating the current time will be inserted at the
appropriate position.

### Control Buttons ###

The user can then control the behaviour of the application with the
four control buttons.

* **Previous date** 
    * *Short press.* Navigate to the previous day.
* **Reset**
    * *Short press.* Switch off Raspberry Pi. Shutdown will be
      instantantious. Press this button before disconnecting power in
      order to avoid corrupting the display.
	  
	  *Note: Unless indicated otherwise by the unit, the power can be
      disconnected at any time without fear of damaging the Raspberry
      Pi.*
    * *Long press.* Re-authenticate user.
* **Scroll**
    * *Short press.* Scroll down and wrap around to the top when the
      last event is reached.
    * *Long press.* Redisplay, showing today's events.
* **Next date**
    * *Short press.* Navigate to the next day.

------------------

<a name="screens">1</a>: At the very least you will need to change
    the value of the SCREEN\_DIMS constant in cal_display.rs
